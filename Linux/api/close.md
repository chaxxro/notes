# close()

`close()` 一个 socket 的缺省行为时把该 socket 标记为已关闭，然后立即返回到调用进程

```cpp
#include <unistd.h>
int close(int fd);
```

套接字可以被多个进程共享，可以理解为我们给每个套接字都设置了一个积分，如果通过 `fork` 的方式产生子进程，套接字就会积分 +1， 如果调用一次 `close` 函数，套接字积分就会 -1

`close` 操作只是使相应 socket 描述字的引用计数 -1，只有当引用计数为 0 的时候，才会触发 TCP 客户端向服务器发送终止连接请求

`close` 函数会要求操作系统回收相关套接字资源，并释放对 ip 地址与端口号二元组的占用，但是由于 tcp 四次挥手最后一个阶段有个 TIME_WAIT 状态，导致与该 socket 相关的端口号资源不会被立即释放，有时候为了达到释放端口用来复用，会设置套接字选项 `SOL_REUSEPORT`

`close` 关闭双向数据流过程：

1. 在输入方向，系统内核会将该套接字设置为不可读，任何读操作都会返回异常

2. 在输出方向，系统内核尝试将发送缓冲区的数据发送给对端，并最后向对端发送一个 FIN 报文，接下来如果再对该套接字进行写操作会返回异常

3. 如果对端没有检测到套接字已关闭，还继续发送报文，就会收到一个 RST 报文